<!-- Sidebar Container -->
<aside
  class="sidebar-container"
  [class.mobile-open]="isMobileMenuOpen()"
  [class.minimized]="isMinimizedState()"
>
  <!-- Header Section -->
  <div class="sidebar-header">
    <div class="brand-section">
      <div class="brand-logo">
        <svg
          width="32"
          height="32"
          viewBox="0 0 64 64"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle
            cx="32"
            cy="32"
            r="30"
            fill="url(#grad1)"
            stroke="#fff"
            stroke-width="2"
          />
          <defs>
            <radialGradient id="grad1" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#a4508b" />
              <stop offset="100%" stop-color="#3a1c71" />
            </radialGradient>
          </defs>
          <rect
            x="26"
            y="40"
            width="12"
            height="6"
            rx="2"
            fill="#fff"
            fill-opacity="0.8"
          />
          <ellipse
            cx="32"
            cy="32"
            rx="10"
            ry="12"
            fill="#fff"
            fill-opacity="0.9"
          />
          <polygon
            points="32,26 33.8,30.2 38.4,30.6 34.8,33.4 36,38 32,35.2 28,38 29.2,33.4 25.6,30.6 30.2,30.2"
            fill="#a4508b"
          />
        </svg>
      </div>
      <div class="brand-text" *ngIf="!isMinimizedState()">
        <h2 class="brand-title">AthletaNX Academy</h2>
        <p class="brand-subtitle">
          {{ selectedBranch()?.name || 'Select Branch' }}
        </p>
      </div>
    </div>

    <!-- Mobile Menu Toggle -->
    <button
      class="mobile-menu-toggle"
      (click)="toggleMobileMenu()"
      [attr.aria-expanded]="isMobileMenuOpen()"
      aria-label="Toggle mobile menu"
    >
      <span class="hamburger-line" [class.active]="isMobileMenuOpen()"></span>
      <span class="hamburger-line" [class.active]="isMobileMenuOpen()"></span>
      <span class="hamburger-line" [class.active]="isMobileMenuOpen()"></span>
    </button>
  </div>

  <!-- Navigation Menu -->
  <nav class="sidebar-nav">
    <ul class="nav-list">
      <li *ngFor="let item of menuItems" class="nav-item">
        <!-- Main Menu Item -->
        <button
          class="nav-link"
          [class.active]="item.isActive"
          [class.expanded]="item.isExpanded && !isMinimizedState()"
          [class.minimized-item]="isMinimizedState()"
          (click)="toggleMenuItem(item, $event)"
          (mouseenter)="showHoverPopup(item, $event)"
          (mouseleave)="hideHoverPopup()"
          [attr.aria-expanded]="item.children && !isMinimizedState() ? item.isExpanded : null"
          [attr.aria-label]="item.label"
        >
          <div class="nav-link-content">
            <i class="nav-icon pi" [ngClass]="item.icon"></i>
            <span class="nav-label" *ngIf="!isMinimizedState()"
              >{{ item.label }}</span
            >
          </div>
          <i
            *ngIf="item.children && !isMinimizedState()"
            class="expand-icon pi pi-chevron-down"
            [class.rotated]="item.isExpanded"
          ></i>
        </button>

        <!-- Submenu -->
        <div
          *ngIf="item.children && !isMinimizedState()"
          class="submenu-container"
          [class.expanded]="item.isExpanded"
        >
          <ul class="submenu-list">
            <li *ngFor="let subItem of item.children" class="submenu-item">
              <!-- Sub Menu Item -->
              <button
                class="submenu-link"
                [class.active]="subItem.isActive"
                [class.expanded]="subItem.isExpanded"
                (click)="toggleSubMenuItem(item, subItem, $event)"
                [attr.aria-expanded]="
                  subItem.children ? subItem.isExpanded : null
                "
                [attr.aria-label]="subItem.label"
              >
                <div class="submenu-link-content">
                  <i class="submenu-icon pi" [ngClass]="subItem.icon"></i>
                  <span class="submenu-label">{{ subItem.label }}</span>
                </div>
                <i
                  *ngIf="subItem.children"
                  class="expand-icon pi pi-chevron-down"
                  [class.rotated]="subItem.isExpanded"
                ></i>
              </button>

              <!-- Nested Submenu (Settings) -->
              <div
                *ngIf="subItem.children"
                class="nested-submenu-container"
                [class.expanded]="subItem.isExpanded"
              >
                <ul class="nested-submenu-list">
                  <li
                    *ngFor="let nestedItem of subItem.children"
                    class="nested-submenu-item"
                  >
                    <button
                      class="nested-submenu-link"
                      [class.active]="nestedItem.isActive"
                      (click)="navigateToRoute(nestedItem)"
                      [attr.aria-label]="nestedItem.label"
                    >
                      <i
                        class="nested-submenu-icon pi"
                        [ngClass]="nestedItem.icon"
                      ></i>
                      <span class="nested-submenu-label"
                        >{{ nestedItem.label }}</span
                      >
                    </button>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Bottom Section -->
  <div class="sidebar-bottom" *ngIf="!isMinimizedState()">
    <!-- Branch Selector with ng-select -->
    <div class="dropdown-section">
      <div class="dropdown-label-text">Branch</div>
      <ng-select
        [items]="branches"
        bindLabel="name"
        bindValue="id"
        [(ngModel)]="selectedBranch"
        (change)="onBranchChange($event)"
        [clearable]="false"
        [searchable]="true"
        placeholder="Select Branch"
        class="ng-select-custom branch-select"
        aria-label="Select Branch"
      >
      </ng-select>
    </div>

    <!-- Sport Selector with ng-select -->
    <div class="dropdown-section">
      <div class="dropdown-label-text">Sport Type</div>
      <ng-select
        [items]="sportTypes"
        bindLabel="name"
        bindValue="id"
        [(ngModel)]="selectedSport"
        (change)="onSportChange($event)"
        [clearable]="false"
        [searchable]="true"
        placeholder="Select Sport"
        class="ng-select-custom sport-select"
        aria-label="Select Sport Type"
      >
      </ng-select>
    </div>
  </div>
</aside>

<!-- Hover Popup for Minimized Sidebar -->
<div
  *ngIf="isMinimizedState() && hoveredItem()"
  class="minimized-hover-popup"
  (mouseenter)="keepPopupVisible()"
  (mouseleave)="hidePopupImmediately()"
>
  <div class="popup-content">
    <div class="popup-header">
      <i class="popup-icon pi" [ngClass]="hoveredItem()?.icon"></i>
      <span class="popup-title">{{ hoveredItem()?.label }}</span>
    </div>

    <!-- Show children if available -->
    <div
      *ngIf="hoveredItem()?.children && hoveredItem()!.children!.length > 0"
      class="popup-submenu"
    >
      <ul class="popup-submenu-list">
        <li
          *ngFor="let subItem of hoveredItem()?.children"
          class="popup-submenu-item"
        >
          <button
            class="popup-submenu-link"
            [class.active]="subItem.isActive"
            (click)="navigateToRoute(subItem); hidePopupImmediately()"
          >
            <i class="popup-submenu-icon pi" [ngClass]="subItem.icon"></i>
            <span class="popup-submenu-label">{{ subItem.label }}</span>
          </button>
        </li>
      </ul>
    </div>

    <!-- Show direct navigation if no children -->
    <div
      *ngIf="!hoveredItem()?.children || hoveredItem()!.children!.length === 0"
      class="popup-direct-nav"
    >
      <button
        class="popup-nav-button"
        (click)="navigateToRoute(hoveredItem()!); hidePopupImmediately()"
      >
        Click to navigate
      </button>
    </div>
  </div>
</div>

<!-- Backdrop for mobile -->
<div
  class="sidebar-backdrop"
  [class.mobile-visible]="isMobileMenuOpen()"
  (click)="toggleMobileMenu()"
  (keydown.escape)="isMobileMenuOpen() && toggleMobileMenu()"
  tabindex="0"
  role="button"
  aria-label="Close sidebar"
></div>
